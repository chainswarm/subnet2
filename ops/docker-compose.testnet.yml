# =============================================================================
# Docker Compose Configuration for TESTNET Subtensor Node
# =============================================================================
# This file contains ONLY the Bittensor testnet-lite subtensor node.
# It is meant to be run SEPARATELY from the application services.
#
# USAGE:
#   1. Start the testnet subtensor node:
#      docker compose -f ops/docker-compose.testnet.yml up -d
#
#   2. Configure application to connect to it in .env:
#      SUBTENSOR_NETWORK=ws://testnet-lite:9944
#
#   3. Start application services separately:
#      docker compose -f ops/docker-compose.yml up -d
#
# NETWORK: test (Bittensor testnet)
#
# PURPOSE:
#   Provides a local Bittensor testnet node for development and testing.
#   The validator will connect to this node instead of remote endpoints.
# =============================================================================

volumes:
  # Subtensor testnet blockchain data
  testnet-lite-volume:
    name: testnet-lite-volume

services:

  # ===========================================================================
  # SUBTENSOR TESTNET-LITE NODE
  # ===========================================================================
  # Lightweight Bittensor testnet node that syncs with the test network.
  # Uses warp sync for fast initial synchronization.
  #
  # Connection:
  #   - RPC Endpoint: ws://localhost:9944 (from host)
  #   - RPC Endpoint: ws://testnet-lite:9944 (from Docker network)
  #   - Syncs with: bootnode.test.finney.opentensor.ai
  #
  # Storage:
  #   - Blockchain data: /data (testnet-lite-volume)
  #   - Mode: Lite (not archive) - only recent state
  #
  # Performance:
  #   - ParityDB for efficient storage
  #   - 4GB DB cache, 2GB trie cache
  #   - Warp sync for fast initial sync (30-60 minutes)
  # ===========================================================================

  testnet-lite:
    image: ghcr.io/opentensor/subtensor:latest
    container_name: subtensor-testnet-lite
    cpu_count: 4
    mem_limit: 40000000000
    memswap_limit: 80000000000
    ports:
      - "9944:9944"
      - "30333:30333"
      - "9933:9933"
    volumes:
      - testnet-lite-volume:/data
      - ./chainspecs:/chainspecs
    command:
      - --base-path=/data
      - --chain=/chainspecs/raw_spec_testfinney.json
      - --rpc-external
      - --rpc-cors=all
      - --no-mdns
      - --bootnodes=/dns/bootnode.test.finney.opentensor.ai/tcp/30333/p2p/12D3KooWPM4mLcKJGtyVtkggqdG84zWrd7Rij6PGQDoijh1X86Vr
      - --sync=warp
      - --database=paritydb
      - --db-cache=4096
      - --trie-cache-size=2048
    environment:
      - CARGO_HOME=/var/www/node-subtensor/.cargo
    restart: always
    networks:
      - subnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  subnet:
    name: subnet
    driver: bridge

# =============================================================================
# DEPLOYMENT INSTRUCTIONS
# =============================================================================
# 
# 1. Start the testnet subtensor node:
#    docker compose -f ops/docker-compose.testnet.yml up -d
#
# 2. Wait for node to sync (30-60 minutes):
#    docker compose -f ops/docker-compose.testnet.yml logs -f testnet-lite
#    # Look for "Syncing" messages and block imports
#
# 3. Configure your .env file to connect to this node:
#    SUBTENSOR_NETWORK=ws://testnet-lite:9944
#
# 4. Start application services (in separate terminal/command):
#    docker compose -f ops/docker-compose.yml up -d
#
# 5. Check node status anytime:
#    docker compose -f ops/docker-compose.testnet.yml ps
#    docker compose -f ops/docker-compose.testnet.yml logs testnet-lite
#
# 6. Stop the node:
#    docker compose -f ops/docker-compose.testnet.yml down
#
# =============================================================================
# TROUBLESHOOTING
# =============================================================================
#
# Node won't sync:
#   - Check network connectivity to bootnode.test.finney.opentensor.ai
#   - Verify port 30333 is not blocked by firewall
#   - Monitor logs for sync progress
#   - Initial sync can take 30-60 minutes
#
# Can't connect from validator:
#   - Ensure both services are on the 'subnet' network
#   - Verify testnet-lite service is healthy
#   - Check SUBTENSOR_NETWORK in .env is correct
#
# Port conflicts on WSL:
#   - If ports are in use, stop other services or change ports
#   - Check: netstat -an | grep 9944
#
# =============================================================================
