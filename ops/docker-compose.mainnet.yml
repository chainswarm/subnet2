# =============================================================================
# Docker Compose Configuration for MAINNET Subtensor Node
# =============================================================================
# This file contains ONLY the Bittensor mainnet-lite subtensor node.
# It is meant to be run SEPARATELY from the application services.
#
# USAGE:
#   1. Start the mainnet subtensor node:
#      docker compose -f ops/docker-compose.mainnet.yml up -d
#
#   2. Configure application to connect to it in .env:
#      SUBTENSOR_NETWORK=ws://mainnet-lite:9944
#
#   3. Start application services separately:
#      docker compose -f ops/docker-compose.yml up -d
#
# NETWORK: finney (Bittensor mainnet/production)
#
# PURPOSE:
#   Provides a local Bittensor mainnet node for production deployment.
#   The validator will connect to this node instead of remote endpoints.
#
# WARNING: This is a PRODUCTION node. Initial sync takes 2-4 hours.
# =============================================================================

volumes:
  # Subtensor mainnet blockchain data
  mainnet-lite-volume:
    name: mainnet-lite-volume

services:

  # ===========================================================================
  # SUBTENSOR MAINNET-LITE NODE
  # ===========================================================================
  # Lightweight Bittensor mainnet node that syncs with the finney network.
  # Uses warp sync for fast initial synchronization.
  #
  # Connection:
  #   - RPC Endpoint: ws://localhost:9944 (from host)
  #   - RPC Endpoint: ws://mainnet-lite:9944 (from Docker network)
  #   - Syncs with: bootnode.finney.chain.opentensor.ai
  #
  # Storage:
  #   - Blockchain data: /data (mainnet-lite-volume)
  #   - Mode: Lite (not archive) - only recent state
  #
  # Performance:
  #   - ParityDB for efficient storage
  #   - 4GB DB cache, 2GB trie cache
  #   - Warp sync for fast initial sync (2-4 hours)
  #
  # IMPORTANT: Initial sync can take 2-4 hours. Monitor logs for progress.
  # ===========================================================================

  mainnet-lite:
    image: ghcr.io/opentensor/subtensor:latest
    container_name: subtensor-mainnet-lite
    cpu_count: 4
    mem_limit: 40000000000
    memswap_limit: 80000000000
    ports:
      - "9944:9944"
      - "30333:30333"
      - "9933:9933"
    volumes:
      - mainnet-lite-volume:/data
      - ./chainspecs:/chainspecs
    command:
      - --base-path=/data
      - --chain=/chainspecs/raw_spec_finney.json
      - --rpc-external
      - --rpc-cors=all
      - --no-mdns
      - --bootnodes=/dns/bootnode.finney.chain.opentensor.ai/tcp/30333/ws/p2p/12D3KooWRwbMb85RWnT8DSXSYMWQtuDwh4LJzndoRrTDotTR5gDC
      - --sync=warp
      - --database=paritydb
      - --db-cache=4096
      - --trie-cache-size=2048
    environment:
      - CARGO_HOME=/var/www/node-subtensor/.cargo
    restart: always
    networks:
      - subnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"

networks:
  subnet:
    name: subnet
    driver: bridge

# =============================================================================
# DEPLOYMENT INSTRUCTIONS
# =============================================================================
# 
# CRITICAL: This is a production mainnet node. Ensure sufficient resources.
#
# 1. Start the mainnet subtensor node:
#    docker compose -f ops/docker-compose.mainnet.yml up -d
#
# 2. Wait for node to sync (2-4 hours) - IMPORTANT!:
#    docker compose -f ops/docker-compose.mainnet.yml logs -f mainnet-lite
#    # Look for "Syncing" messages and block imports
#    # Wait until sync is complete before starting validator
#
# 3. Configure your .env file to connect to this node:
#    SUBTENSOR_NETWORK=ws://mainnet-lite:9944
#
# 4. Start application services (AFTER node is synced):
#    docker compose -f ops/docker-compose.yml up -d
#
# 5. Monitor node status:
#    docker compose -f ops/docker-compose.mainnet.yml ps
#    docker compose -f ops/docker-compose.mainnet.yml logs mainnet-lite
#
# 6. Stop the node:
#    docker compose -f ops/docker-compose.mainnet.yml down
#
# =============================================================================
# RESOURCE REQUIREMENTS
# =============================================================================
#
# Minimum System Requirements:
#   - CPU: 4 cores
#   - RAM: 40GB available
#   - Disk: 100GB+ free space (blockchain data grows)
#   - Network: Stable internet connection, port 30333 open
#
# Monitor disk usage regularly:
#   du -sh /var/lib/docker/volumes/mainnet-lite-volume
#
# =============================================================================
# SECURITY CONSIDERATIONS
# =============================================================================
#
# 1. Network Security:
#    - Port 30333 must be accessible for P2P sync
#    - Port 9944 should only be accessible to trusted services
#    - Consider firewall rules to restrict RPC access
#
# 2. Resource Monitoring:
#    - Set up alerts for disk space (blockchain data grows)
#    - Monitor memory usage
#    - Track CPU utilization
#
# 3. Backup Strategy:
#    - Blockchain data can be re-synced (no backup needed)
#    - Focus backup efforts on application data
#
# =============================================================================
# TROUBLESHOOTING
# =============================================================================
#
# Node won't sync:
#   - Check network connectivity to bootnode.finney.chain.opentensor.ai
#   - Verify port 30333 is not blocked by firewall
#   - Monitor logs for sync progress
#   - Initial sync can take 2-4 hours (be patient)
#   - Check disk space (blockchain data can be large)
#
# Can't connect from validator:
#   - Ensure both services are on the 'subnet' network
#   - Verify mainnet-lite service is healthy
#   - Ensure subtensor sync is complete
#   - Check SUBTENSOR_NETWORK in .env is correct
#
# Performance issues:
#   - Verify system meets minimum requirements
#   - Check disk I/O performance
#   - Monitor memory usage
#   - Consider increasing cache sizes if RAM available
#
# Port conflicts on WSL:
#   - If ports are in use, stop other services or change ports
#   - Check: netstat -an | grep 9944
#
# =============================================================================
